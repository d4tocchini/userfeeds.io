<!DOCTYPE html>
<html>
<head>
  <title>Sponsred ranking for Ethereum:</title>
  <style type="text/css">
    ul#choices li {
      list-style: none;
      display: inline-block;
    }

    ul#choices li img {
      width: 200px;
      height: auto;
    }

    div#ranking img {
      width: 180px;
      height: auto;
      margin-right: 20px;
    }

    ul.winners li {
      display: inline-block;
    }
  </style>
</head>
<body>
  <h1>Winners:</h1>
  <div id="ranking"></div>

  Ranking address:<input type="text" id="address" value="rinkeby:0xfe5da6ae3f65e7d5ce29121a9f5872ffd83b45e6"/>
  <button onclick="init();">Refresh</button>


  <h1>Which is the best animal?:</h1>
  <ul id="choices">
    <li>
      <img id="cat" src="img/cat.png">
      <br/>
      <button onclick="promote(this, 0.01);">Promote by 0.01 Ether</button><br/>
      <button onclick="promote(this, 0.1);">Promote by 0.1 Ether</button><br/>
      <button onclick="promote(this, 1);">Promote by 1 Ether</button>
    </li>
    <li>
      <img id="dog" src="img/dog.png">
      <br/>
      <button onclick="promote(this, 0.01);">Promote by 0.01 Ether</button><br/>
      <button onclick="promote(this, 0.1);">Promote by 0.1 Ether</button><br/>
      <button onclick="promote(this, 1);">Promote by 1 Ether</button>
    </li>
    <li>
      <img id="horse" src="img/horse.png">
      <br/>
      <button onclick="promote(this, 0.01);">Promote by 0.01 Ether</button><br/>
      <button onclick="promote(this, 0.1);">Promote by 0.1 Ether</button><br/>
      <button onclick="promote(this, 1);">Promote by 1 Ether</button>
    </li>
    <li>
      <img id="bird" src="img/bird.png">
      <br/>
      <button onclick="promote(this, 0.01);">Promote by 0.01 Ether</button><br/>
      <button onclick="promote(this, 0.1);">Promote by 0.1 Ether</button><br/>
      <button onclick="promote(this, 1);">Promote by 1 Ether</button>
    </li>
  </ul>

  <script>
    var rankingAddress = null;
    var content = {};

    function init() {
      rankingAddress = document.getElementById('address').value;

      var choices = document.getElementById('choices').getElementsByTagName("li");

      for (var i = choices.length - 1; i >= 0; i--) {
        var img = choices[i].getElementsByTagName('img')[0];
        content[img.id] = img.src;
      }

      displayRanking();
    }

    function displayRanking() {
      fetch(`https://api.userfeeds.io/ranking/${rankingAddress}/sponsored/`)
      .then(response => response.json())
      .then(ranking => {
        let div = document.getElementById('ranking');

        let html = '<ul class="winners">';
        for (let i = 0; i <= 3; i++) {
          let item = ranking.items[i];
          if (item) {
            let src = content[toAscii(item.target)];
            let score = item.score;
            if (src) {
              html += `<li><img src="${src}"><br/>Score: ${score}</li>`;
            }
          }
        }
        html += '</ul>';

        div.innerHTML = html;
      });
    }

    function promote(button, value) {
      var img = button.parentElement.getElementsByTagName('img')[0];

      // Send identifier as transaction data
      var data = web3.fromAscii(img.id);

      web3.eth.sendTransaction({to: rankingAddress.split(':')[1], data: data, value: web3.toWei(value, 'ether')}, function(err, address) {
        if (!err)
          alert("Thank You!");
      });
    }

    function toAscii (hex) {
        var str = '',
            i = 0,
            l = hex.length;
        if (hex.substring(0, 2) === '0x') {
            i = 2;
        }
        for (; i < l; i+=2) {
            var code = parseInt(hex.substr(i, 2), 16);
            if (code === 0) continue; // this is added
            str += String.fromCharCode(code);
        }
        return str;
    };

    init();
  </script>
</body>
</html>


